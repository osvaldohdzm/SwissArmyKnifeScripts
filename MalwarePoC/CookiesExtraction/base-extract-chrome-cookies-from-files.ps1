param (
    [Parameter(Mandatory=$true, HelpMessage="Especifica la ruta del archivo Cookies.")]
    [ValidateNotNullOrEmpty()]
    [string]$CookiesFile,

    [Parameter(Mandatory=$true, HelpMessage="Especifica la ruta del archivo Local State.")]
    [ValidateNotNullOrEmpty()]
    [string]$LocalStateFile
)

$outputFile = "cookies.txt"
$tempFile = "$env:TEMP\chrome_cookies.tmp"
$sqlQuery = "SELECT host_key, is_secure, path, expires_utc, name, encrypted_value FROM cookies"

if (Test-Path $outputFile) {
    Remove-Item $outputFile
}

Write-Host "Exportando las cookies de Chrome..."

# Extraer cookies a un archivo temporal
sqlite3 $CookiesFile $sqlQuery > $tempFile

Add-Content $outputFile "# Netscape HTTP Cookie File"
Add-Content $outputFile "# http://curl.haxx.se/rfc/cookie_spec.html"
Add-Content $outputFile "# Este es un archivo generado automáticamente. No editar."
Add-Content $outputFile ""
Add-Content $outputFile "# Dominio    Subdominio   Ruta    Segura    Caducidad    Nombre    Valor"

# Leer las cookies y formatearlas en formato Netscape
Get-Content $tempFile | ForEach-Object {
    $fields = $_.Split("|")
    $domain = $fields[0]
    $subdomain = "TRUE"
    $path = $fields[2]
    $secure = "TRUE"
    $expiration = $fields[3]
    $name = $fields[4]
    $encryptedValue = $fields[5]

    # Descifrar el valor encriptado utilizando el algoritmo de descifrado y la clave de cifrado
    # TODO: Agrega tu código de descifrado aquí para descifrar el valor encriptado

    $decryptedValue = "DECRYPTED_VALUE"

    Add-Content $outputFile "$domain    $subdomain    $path    $secure    $expiration    $name    $decryptedValue"
}

Remove-Item $tempFile

Write-Host "Exportación completada. Las cookies se exportaron a $outputFile."

# Obtener la clave encriptada
$localStateJson = Get-Content -Raw $LocalStateFile | ConvertFrom-Json
$encryptedKey = $localStateJson.os_crypt.encrypted_key

Write-Host "Clave encriptada: $encryptedKey"
